schema: '2.0'
stages:
  ingest_kaggle:
    cmd: python scripts/data_ingestion/descarga_kaggle_reviews.py --out 
      data/landing/sephora/raw
    deps:
    - path: scripts/data_ingestion/descarga_kaggle_reviews.py
      hash: md5
      md5: e27b06cc672ef4f0b2347bf61ccb6322
      size: 762
    outs:
    - path: data/landing/sephora/raw
      hash: md5
      md5: 8b7019941c39ea0d57fae739d69994b5.dir
      size: 528949733
      nfiles: 6
  conversion_a_delta:
    cmd: python scripts/data_cleaning/conversion_a_delta.py --input 
      data/landing/sephora/raw --output data/landing/sephora/delta
    deps:
    - path: data/landing/sephora/raw
      hash: md5
      md5: 8b7019941c39ea0d57fae739d69994b5.dir
      size: 528949733
      nfiles: 6
    - path: scripts/data_cleaning/conversion_a_delta.py
      hash: md5
      md5: c3a4ec2564051338d2f39b94ceff02c7
      size: 2042
    outs:
    - path: data/landing/sephora/delta
      hash: md5
      md5: 18e2c59c26cb32a1e9f0c6d01a16fb62.dir
      size: 231057821
      nfiles: 188
  trusted_clean_driver:
    cmd: python scripts/data_cleaning/trusted_clean_driver.py --input 
      data/landing/sephora/delta --output data/trusted/sephora_clean
    deps:
    - path: data/landing/sephora/delta
      hash: md5
      md5: 18e2c59c26cb32a1e9f0c6d01a16fb62.dir
      size: 231057821
      nfiles: 188
    - path: scripts/data_cleaning/trusted_clean_driver.py
      hash: md5
      md5: 0022c1ecb46a3cc4bf95efd3523fec79
      size: 804
    - path: scripts/data_cleaning/trusted_clean_single.py
      hash: md5
      md5: e9f9c94752272c42f4c257b369e68e8b
      size: 4336
    outs:
    - path: data/trusted/sephora_clean
      hash: md5
      md5: a0246dc2dfdbaa1d2e8cdf26dae85acd.dir
      size: 501938321
      nfiles: 304
  merge_trusted_reviews:
    cmd: python scripts/data_cleaning/merge_trusted_reviews.py --input-dir 
      data/trusted/sephora_clean --output data/trusted/reviews_full
    deps:
    - path: data/trusted/sephora_clean
      hash: md5
      md5: a0246dc2dfdbaa1d2e8cdf26dae85acd.dir
      size: 501938321
      nfiles: 304
    - path: scripts/data_cleaning/merge_trusted_reviews.py
      hash: md5
      md5: 451be47cd2deaffc43e011a63e87b999
      size: 1948
    outs:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14128897a3e2c9079b0a5b1acd29f682.dir
      size: 493953700
      nfiles: 18
  eda_full:
    cmd: python scripts/EDA/eda_reviews.py --input data/trusted/reviews_full 
      --outdir reports/eda/full --tokenizer albert-base-v2
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14128897a3e2c9079b0a5b1acd29f682.dir
      size: 493953700
      nfiles: 18
    - path: params.yaml
      hash: md5
      md5: 32c2fa578c378de36d8ba972d2a8972c
      size: 1092
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/full
      hash: md5
      md5: 3aad1f61c78a3817f3f5df5c3329caa1.dir
      size: 41072
      nfiles: 8
  sample_reviews:
    cmd: "python scripts/data_cleaning/sample_reviews.py --input data/trusted/reviews_full
      --output data/trusted/reviews_sample_30pct --frac 0.30 --by labels --seed 42\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14128897a3e2c9079b0a5b1acd29f682.dir
      size: 493953700
      nfiles: 18
    - path: scripts/data_cleaning/sample_reviews.py
      hash: md5
      md5: b53be00c693d1b0eca07a1c53acbfe64
      size: 3658
    outs:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: f80c5d74003744329fc203f46d56f4ec.dir
      size: 148645087
      nfiles: 14
  eda_sample:
    cmd: python scripts/EDA/eda_reviews.py --input 
      data/trusted/reviews_sample_30pct --outdir reports/eda/sample_30pct 
      --tokenizer albert-base-v2
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: f80c5d74003744329fc203f46d56f4ec.dir
      size: 148645087
      nfiles: 14
    - path: params.yaml
      hash: md5
      md5: 32c2fa578c378de36d8ba972d2a8972c
      size: 1092
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/sample_30pct
      hash: md5
      md5: 75fd3a031d2a43f659e3d699a42c7e98.dir
      size: 40926
      nfiles: 8
  eda_compare_full_vs_sample_30pct:
    cmd: python scripts/EDA/eda_compare.py --full reports/eda/full --sample 
      reports/eda/sample_30pct --outdir reports/eda/compare_full_vs_sample_30pct
    deps:
    - path: reports/eda/full
      hash: md5
      md5: 3aad1f61c78a3817f3f5df5c3329caa1.dir
      size: 41072
      nfiles: 8
    - path: reports/eda/sample_30pct
      hash: md5
      md5: 75fd3a031d2a43f659e3d699a42c7e98.dir
      size: 40926
      nfiles: 8
    - path: scripts/EDA/eda_compare.py
      hash: md5
      md5: ccbfd0ac430439ce9b8480693f4f6702
      size: 6597
    outs:
    - path: reports/eda/compare_full_vs_sample_30pct
      hash: md5
      md5: fb163b34ac43d39149dd3aa6b79ab905.dir
      size: 762
      nfiles: 7
  split_train_val_test:
    cmd: "python scripts/training/prepare_test_parquet.py --input  data/trusted/reviews_sample_30pct
      --outdir data/exploitation/modelos_input/sample_tvt --seed 42\n"
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: f80c5d74003744329fc203f46d56f4ec.dir
      size: 148645087
      nfiles: 14
    - path: params.yaml
      hash: md5
      md5: e7d8b527385eff4021a5da943a37cdd0
      size: 1528
    - path: scripts/training/prepare_test_parquet.py
      hash: md5
      md5: a38fe0bf5ce66343d73258b8d10496f8
      size: 4480
    outs:
    - path: data/exploitation/modelos_input/sample_tvt
      hash: md5
      md5: bf691f8a021b8519abd35f7e97b229a5.dir
      size: 149337296
      nfiles: 3
  train_albert_sample:
    cmd: "MLFLOW_RUN_NAME=albert_sample_30pct python scripts/training/train_albert_from_parquets.py
      --train data/exploitation/modelos_input/sample_tvt/train --val   data/exploitation/modelos_input/sample_tvt/val
      --model-out models/albert_sample_30pct --params params.yaml\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/train
      hash: md5
      md5: 7cd73ea1291404d41796bff9a9903688.dir
      size: 111804078
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/val
      hash: md5
      md5: 1a7dde8360bfec37f8e3438a8eba43fa.dir
      size: 15074562
      nfiles: 1
    - path: params.yaml
      hash: md5
      md5: 8567379da3286211436e6485150cff0b
      size: 1084
    - path: scripts/training/train_albert_from_parquets.py
      hash: md5
      md5: 812b19737dfdf297a8786ff4aadc0f52
      size: 31873
    outs:
    - path: models/albert_sample_30pct
      hash: md5
      md5: 09123040986b9e0055a4cfaf1437d0ec.dir
      size: 49783739
      nfiles: 8
  evaluate_albert_sample:
    cmd: "PYTHONNOUSERSITE=1 TRANSFORMERS_NO_TF=1 TRANSFORMERS_NO_JAX=1 USE_TF=0 USE_JAX=0
      /home/pedro/MASTER_BIGDATA/venv/bin/python scripts/training/evaluate_albert.py
      --model_dir models/albert_sample_30pct --test_parquet data/exploitation/modelos_input/sample_tvt/test
      --max_len 176 --output_dir reports/albert_sample_30pct/eval\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/test
      hash: md5
      md5: 4e1e5bc784eb65d9efa5d987041826b1.dir
      size: 22633099
      nfiles: 1
    - path: models/albert_sample_30pct
      hash: md5
      md5: 09123040986b9e0055a4cfaf1437d0ec.dir
      size: 49783739
      nfiles: 8
    - path: scripts/training/evaluate_albert.py
      hash: md5
      md5: bd058aeb7397b18b388cbcdb4c3e11ce
      size: 10950
    outs:
    - path: reports/albert_sample_30pct/eval
      hash: md5
      md5: 0f978df4d7eb9342b734e76040efb16d.dir
      size: 2987688
      nfiles: 6
  train_rf_sample:
    cmd: "MLFLOW_RUN_NAME=rf_sample_30pct python scripts/training/train_random_forest.py
      --train data/exploitation/modelos_input/sample_tvt/train --val   data/exploitation/modelos_input/sample_tvt/val
      --model-out models/sentiment_rf_sample --params params.yaml\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/train
      hash: md5
      md5: e77158751e74415e60654d34d2484f04.dir
      size: 111787992
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/val
      hash: md5
      md5: 1be9aca30775ecb63513e5109c0eb2ad.dir
      size: 15112229
      nfiles: 1
    - path: params.yaml
      hash: md5
      md5: e7d8b527385eff4021a5da943a37cdd0
      size: 1528
    - path: scripts/training/train_random_forest.py
      hash: md5
      md5: 514f31ec650499ee2998b0ec845527df
      size: 9625
    outs:
    - path: models/sentiment_rf_sample
      hash: md5
      md5: 8c419e750605f9537a640d696dbb4d0f.dir
      size: 1004428105
      nfiles: 3
    - path: reports/sentiment_rf
      hash: md5
      md5: d8ebeb8010ca4591a71ef319338444d3.dir
      size: 12766
      nfiles: 1
  evaluate_rf_sample:
    cmd: "python scripts/training/infer_random_forest.py --model-dir models/sentiment_rf_sample
      --input data/exploitation/modelos_input/sample_tvt/test --output-dir reports/sentiment_rf_sample/eval
      --text-col review_text --id-col review_id --use-extra 1 && python scripts/evaluation/metrics_overall.py
      --preds reports/sentiment_rf_sample/eval/test_predictions.parquet --out_dir
      reports/sentiment_rf_sample/eval\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/test
      hash: md5
      md5: 61c285effc7c4927cc2bd0c7b7cd1787.dir
      size: 22437075
      nfiles: 1
    - path: models/sentiment_rf_sample
      hash: md5
      md5: 8c419e750605f9537a640d696dbb4d0f.dir
      size: 1004428105
      nfiles: 3
    - path: scripts/evaluation/metrics_overall.py
      hash: md5
      md5: 5f870271995dc8e4e110e56c3fe57a02
      size: 2244
      isexec: true
    - path: scripts/training/infer_random_forest.py
      hash: md5
      md5: 3528358c2c087c7af6d3da3f620150b8
      size: 5670
    outs:
    - path: reports/sentiment_rf_sample/eval
      hash: md5
      md5: e26791bee782e854189cdd4cf16ceb7f.dir
      size: 2112037
      nfiles: 4
