schema: '2.0'
stages:
  ingest_kaggle:
    cmd: "python scripts/data_ingestion/descarga_kaggle_reviews.py --out data/landing/sephora/raw\n"
    deps:
    - path: scripts/data_ingestion/descarga_kaggle_reviews.py
      hash: md5
      md5: e27b06cc672ef4f0b2347bf61ccb6322
      size: 762
    outs:
    - path: data/landing/sephora/raw
      hash: md5
      md5: 8b7019941c39ea0d57fae739d69994b5.dir
      size: 528949733
      nfiles: 6
  conversion_a_delta:
    cmd: "python scripts/data_cleaning/conversion_a_delta.py --input data/landing/sephora/raw
      --output data/landing/sephora/delta\n"
    deps:
    - path: data/landing/sephora/raw
      hash: md5
      md5: 8b7019941c39ea0d57fae739d69994b5.dir
      size: 528949733
      nfiles: 6
    - path: scripts/data_cleaning/conversion_a_delta.py
      hash: md5
      md5: f2e92a0eb8508d5d7f9f8543545af804
      size: 1737
    outs:
    - path: data/landing/sephora/delta
      hash: md5
      md5: 0e40bd239d8164baa8d31fdb702b9c3b.dir
      size: 230119217
      nfiles: 172
  trusted_clean_driver:
    cmd: "python scripts/data_cleaning/trusted_clean_driver.py --input  data/landing/sephora/delta
      --output data/trusted/sephora_clean\n"
    deps:
    - path: data/landing/sephora/delta
      hash: md5
      md5: 0e40bd239d8164baa8d31fdb702b9c3b.dir
      size: 230119217
      nfiles: 172
    - path: scripts/data_cleaning/trusted_clean_driver.py
      hash: md5
      md5: 12fb524919587f142c3e2d8a0b638787
      size: 805
    - path: scripts/data_cleaning/trusted_clean_single.py
      hash: md5
      md5: e9f9c94752272c42f4c257b369e68e8b
      size: 4336
    outs:
    - path: data/trusted/sephora_clean/product_info
      hash: md5
      md5: 3577e02353a591c15b8c577aa684ab64.dir
      size: 2837914
      nfiles: 10
    - path: data/trusted/sephora_clean/reviews_0_250
      hash: md5
      md5: cbb8686a5ddcda1718e9e769dec402a7.dir
      size: 267928038
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_1250_end
      hash: md5
      md5: 8072752805ff8578438714cb65f5610e.dir
      size: 24234532
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_250_500
      hash: md5
      md5: 7151dafb09764812dc79b98df3e62c73.dir
      size: 95799300
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_500_750
      hash: md5
      md5: b06b5bcc8f0cfb1cdf76e71e6b3bfbd1.dir
      size: 54040580
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_750_1250
      hash: md5
      md5: 2724f4e3837f8d9111976fa0d05fa6db.dir
      size: 56044298
      nfiles: 48
  merge_trusted_reviews:
    cmd: "python scripts/data_cleaning/merge_trusted_reviews.py --input-dir data/trusted/sephora_clean
      --output    data/trusted/reviews_full --format delta --coalesce  64\n"
    deps:
    - path: data/trusted/sephora_clean/product_info
      hash: md5
      md5: 3577e02353a591c15b8c577aa684ab64.dir
      size: 2837914
      nfiles: 10
    - path: data/trusted/sephora_clean/reviews_0_250
      hash: md5
      md5: cbb8686a5ddcda1718e9e769dec402a7.dir
      size: 267928038
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_1250_end
      hash: md5
      md5: 8072752805ff8578438714cb65f5610e.dir
      size: 24234532
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_250_500
      hash: md5
      md5: 7151dafb09764812dc79b98df3e62c73.dir
      size: 95799300
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_500_750
      hash: md5
      md5: b06b5bcc8f0cfb1cdf76e71e6b3bfbd1.dir
      size: 54040580
      nfiles: 48
    - path: data/trusted/sephora_clean/reviews_750_1250
      hash: md5
      md5: 2724f4e3837f8d9111976fa0d05fa6db.dir
      size: 56044298
      nfiles: 48
    - path: scripts/data_cleaning/merge_trusted_reviews.py
      hash: md5
      md5: 328357b16b26547e2b06709acb583b63
      size: 5557
    outs:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 4485207d96ba5a6d739a8b5570c6df6d.dir
      size: 495378510
      nfiles: 18
  eda_full:
    cmd: "python scripts/EDA/eda_reviews.py --input data/trusted/reviews_full --outdir
      reports/eda/full --tokenizer albert-base-v2\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 4485207d96ba5a6d739a8b5570c6df6d.dir
      size: 495378510
      nfiles: 18
    - path: params.yaml
      hash: md5
      md5: 3322653cf5ce2b5dc6494dde8d8a6dde
      size: 2207
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/full
      hash: md5
      md5: 468d72acb76f922c40ea44be303550ea.dir
      size: 91181
      nfiles: 10
  sample_reviews:
    cmd: "python scripts/data_cleaning/sample_reviews.py --input data/trusted/reviews_full
      --output data/trusted/reviews_sample_30pct --frac 0.30 --by labels --seed 42\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 08549c8975b204736b6d85c1bb6a55a8.dir
      size: 493840996
      nfiles: 18
    - path: scripts/data_cleaning/sample_reviews.py
      hash: md5
      md5: b53be00c693d1b0eca07a1c53acbfe64
      size: 3658
    outs:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 2f4abe9eececec8710ea87937d163ea7.dir
      size: 148792281
      nfiles: 18
  eda_sample:
    cmd: python scripts/EDA/eda_reviews.py --input 
      data/trusted/reviews_sample_30pct --outdir reports/eda/sample_30pct 
      --tokenizer albert-base-v2
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 2f4abe9eececec8710ea87937d163ea7.dir
      size: 148792281
      nfiles: 18
    - path: params.yaml
      hash: md5
      md5: 1cc224cc01c4ed14dd211f948a3e9977
      size: 1052
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/sample_30pct
      hash: md5
      md5: f00407d91fdf27502b34286c503e82a3.dir
      size: 88768
      nfiles: 10
  eda_compare_full_vs_sample_30pct:
    cmd: python scripts/EDA/eda_compare.py --full reports/eda/full --sample 
      reports/eda/sample_30pct --outdir reports/eda/compare_full_vs_sample_30pct
    deps:
    - path: reports/eda/full
      hash: md5
      md5: 7bf3ddaa898dd7f5fd79c27084c2c550.dir
      size: 91160
      nfiles: 10
    - path: reports/eda/sample_30pct
      hash: md5
      md5: f00407d91fdf27502b34286c503e82a3.dir
      size: 88768
      nfiles: 10
    - path: scripts/EDA/eda_compare.py
      hash: md5
      md5: ccbfd0ac430439ce9b8480693f4f6702
      size: 6597
    outs:
    - path: reports/eda/compare_full_vs_sample_30pct
      hash: md5
      md5: ac22c9f240eab39a98b6d5ffa5db78a9.dir
      size: 6506
      nfiles: 7
  split_train_val_test:
    cmd: "python scripts/training/prepare_test_parquet.py --input  data/trusted/reviews_sample_30pct
      --outdir data/exploitation/modelos_input/sample_tvt --seed 42\n"
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 3c913bd98909183982d0cc53110a1da0.dir
      size: 143121002
      nfiles: 50
    - path: params.yaml
      hash: md5
      md5: 3322653cf5ce2b5dc6494dde8d8a6dde
      size: 2207
    - path: scripts/training/prepare_test_parquet.py
      hash: md5
      md5: 347ee9d1a01887aea96a63ae36cad088
      size: 4478
    outs:
    - path: data/exploitation/modelos_input/sample_tvt
      hash: md5
      md5: 0c9a7ed18242b33b7c2e73ba250ce80f.dir
      size: 141534125
      nfiles: 3
  train_albert_sample:
    cmd: "MLFLOW_RUN_NAME=albert_sample_30pct python scripts/training/train_albert_from_parquets.py
      --train data/exploitation/modelos_input/sample_tvt/train --val   data/exploitation/modelos_input/sample_tvt/val
      --model-out models/albert_sample_30pct --params params.yaml\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/train
      hash: md5
      md5: 9209563c84f500f95462c3c20a78aaf0.dir
      size: 106044050
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/val
      hash: md5
      md5: 3897382c33dacb582249c542f7c79759.dir
      size: 14238818
      nfiles: 1
    - path: params.yaml
      hash: md5
      md5: 3322653cf5ce2b5dc6494dde8d8a6dde
      size: 2207
    - path: scripts/training/train_albert_from_parquets.py
      hash: md5
      md5: abf0b5fb9563be466a538cf21764d5ad
      size: 31872
    outs:
    - path: models/albert_sample_30pct
      hash: md5
      md5: 923ed8e16d5c6e248094aff1bf38c3cf.dir
      size: 49784962
      nfiles: 8
  evaluate_albert_sample:
    cmd: "PYTHONNOUSERSITE=1 TRANSFORMERS_NO_TF=1 TRANSFORMERS_NO_JAX=1 USE_TF=0 USE_JAX=0
      /home/pedro/MASTER_BIGDATA/venv/bin/python scripts/training/evaluate_albert.py
      --model_dir models/albert_sample_30pct --test_parquet data/exploitation/modelos_input/sample_tvt/test
      --output_dir reports/albert_sample_30pct/eval\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/test
      hash: md5
      md5: bfa024e0523b5306f46976ba7d064f60.dir
      size: 21251257
      nfiles: 1
    - path: models/albert_sample_30pct
      hash: md5
      md5: 923ed8e16d5c6e248094aff1bf38c3cf.dir
      size: 49784962
      nfiles: 8
    - path: scripts/training/evaluate_albert.py
      hash: md5
      md5: 65666831a43b30e2c23a14ae56ac6214
      size: 10535
    outs:
    - path: reports/albert_sample_30pct/eval
      hash: md5
      md5: ff2869b28cd6b9e7c4e6e5fe3b5bd671.dir
      size: 2837721
      nfiles: 6
  train_albert:
    cmd: "python scripts/training/train_albert_from_parquets.py --train data/trusted/splits/train
      --val   data/trusted/splits/val --model-out models/albert_sample_30pct --params
      params.yaml\n"
    deps:
    - path: data/trusted/splits/train
      hash: md5
      md5: 65af6292cf6401a314390f0de62fc38a.dir
      size: 64893152
      nfiles: 18
    - path: data/trusted/splits/val
      hash: md5
      md5: fc3b1f9f978117ee50cd4c007fb2a2ae.dir
      size: 28380878
      nfiles: 18
    - path: params.yaml
      hash: md5
      md5: 5a9b64da1df3b206ebc3bf5bef6d42f3
      size: 3061
    - path: scripts/training/train_albert_from_parquets.py
      hash: md5
      md5: 26a546ff762a2c400ba78a867913b983
      size: 22305
    outs:
    - path: models/albert_sample_30pct
      hash: md5
      md5: c45f462a87128665e61a6c2fa9967281.dir
      size: 386202977
      nfiles: 35
  infer_albert_all:
    cmd: "python scripts/training/infer_albert_all.py --model_dir models/albert_sample_30pct
      --input_parquet data/trusted/reviews_full --output_parquet reports/albert_sample_30pct/infer/predictions.parquet
      --eval_output_dir reports/albert_sample_30pct/infer_eval_full --text_col review_text_clean
      --id_col review_id --label_col label --max_length 192 --batch_size 256 --labels
      negative neutral positive\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 660f5d166d2f7ad288ca7729c8deb3e9.dir
      size: 495606028
      nfiles: 24
    - path: models/albert_sample_30pct
      hash: md5
      md5: d71a6277af2ec5b4120fa66aea0113cf.dir
      size: 49784806
      nfiles: 8
    - path: scripts/training/infer_albert_all.py
      hash: md5
      md5: 0664a8fb2bf0e4cc6dccb16a5c9ba619
      size: 10348
    params:
      params.yaml:
        infer:
          model_dir: models/albert_sample_30pct
          input_parquet: data/trusted/reviews_full
          output_parquet: reports/albert_sample_30pct/infer/predictions.parquet
          eval_output_dir: reports/albert_sample_30pct/infer_eval_full
          text_col: review_text_clean
          id_col: review_id
          label_col: label
          batch_size: 1280
          max_length: 192
    outs:
    - path: reports/albert_sample_30pct/infer/predictions.parquet
      hash: md5
      md5: 17bea98847c6a5beeef26f487a17fa5e
      size: 42520506
  trusted_sample_30:
    cmd: "python scripts/data_cleaning/sample_reviews.py --input  data/trusted/reviews_full
      --output data/trusted/reviews_sample_30pct --frac 0.3 --by sentiment_category
      --format delta --seed 42 --coalesce 64 --balance true\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 4485207d96ba5a6d739a8b5570c6df6d.dir
      size: 495378510
      nfiles: 18
    - path: scripts/data_cleaning/sample_reviews.py
      hash: md5
      md5: fd98cc639796fd46d1361d8b2fe224c3
      size: 8858
    params:
      params.yaml:
        sampling:
          frac: 0.3
          by: sentiment_category
          seed: 42
          format: delta
          coalesce: 64
          balance: true
    outs:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 3c913bd98909183982d0cc53110a1da0.dir
      size: 143121002
      nfiles: 50
  eda_sample_30:
    cmd: "python scripts/EDA/eda_reviews.py --input data/trusted/reviews_sample_30pct
      --outdir reports/eda/sample_30 --tokenizer albert-base-v2\n"
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 3c913bd98909183982d0cc53110a1da0.dir
      size: 143121002
      nfiles: 50
    - path: params.yaml
      hash: md5
      md5: 3322653cf5ce2b5dc6494dde8d8a6dde
      size: 2207
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/sample_30
      hash: md5
      md5: 333147882034d0d369407eef0e05b054.dir
      size: 86603
      nfiles: 10
  eda_compare_full_vs_30:
    cmd: "python scripts/EDA/eda_compare.py --a data/trusted/reviews_full --b data/trusted/reviews_sample_30pct
      --outdir reports/eda/compare_full_vs_30 --by sentiment_category --input-format
      auto --tokenizer albert-base-v2 --sample-rows 120000 --max-len 128 --clip-tokens
      true --silence-tokenizer-warnings true\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 4485207d96ba5a6d739a8b5570c6df6d.dir
      size: 495378510
      nfiles: 18
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 3c913bd98909183982d0cc53110a1da0.dir
      size: 143121002
      nfiles: 50
    - path: scripts/EDA/eda_compare.py
      hash: md5
      md5: 47f357297a778055cea6698a7b44810b
      size: 11381
    params:
      params.yaml:
        eda_compare_full_vs_30:
          a: data/trusted/reviews_full
          b: data/trusted/reviews_sample_30pct
          outdir: reports/eda/compare_full_vs_30
          by: sentiment_category
          input_format: auto
          tokenizer: albert-base-v2
          sample_rows: 120000
          max_len: 128
          clip_tokens: true
          silence_tokenizer_warnings: true
    outs:
    - path: reports/eda/compare_full_vs_30
      hash: md5
      md5: 05e53a4dae24edd72f181b6bb9f2b098.dir
      size: 59628
      nfiles: 24
  infer_albert_forward:
    cmd: "PYTHONNOUSERSITE=1 TRANSFORMERS_NO_TF=1 TRANSFORMERS_NO_JAX=1 USE_TF=0 USE_JAX=0
      /home/pedro/MASTER_BIGDATA/venv/bin/python scripts/training/infer_albert_all.py
      --model_dir models/albert_sample_30pct --input_parquet data/trusted/reviews_full
      --output_parquet reports/albert_sample_30pct/infer/predictions.parquet --eval_output_dir
      reports/albert_sample_30pct/infer_eval_full --text_col review_text_clean --id_col
      review_id --batch_size 128\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: aeee9d89c9d221c5a91da28ee292a39b.dir
      size: 494842050
      nfiles: 82
    - path: models/albert_sample_30pct
      hash: md5
      md5: d71a6277af2ec5b4120fa66aea0113cf.dir
      size: 49784806
      nfiles: 8
    - path: scripts/training/infer_albert_all.py
      hash: md5
      md5: 24f7a940fafa350c7ee192dba1f2969b
      size: 4038
    outs:
    - path: reports/albert_sample_30pct/infer/predictions.parquet
      hash: md5
      md5: a5fedaafa341c219fec1b6bb8c03bb76
      size: 43106181
  make_rest_from_full:
    cmd: "python scripts/data_cleaning/make_rest_from_full.py --full data/trusted/reviews_full
      --sample-root data/exploitation/modelos_input/sample_tvt --sample-delta data/trusted/reviews_sample_30pct
      --out data/exploitation/modelos_input/rest_from_full --format parquet --coalesce
      64\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/test
      hash: md5
      md5: bfa024e0523b5306f46976ba7d064f60.dir
      size: 21251257
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/train
      hash: md5
      md5: 9209563c84f500f95462c3c20a78aaf0.dir
      size: 106044050
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/val
      hash: md5
      md5: 3897382c33dacb582249c542f7c79759.dir
      size: 14238818
      nfiles: 1
    - path: data/trusted/reviews_full
      hash: md5
      md5: 4485207d96ba5a6d739a8b5570c6df6d.dir
      size: 495378510
      nfiles: 18
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 3c913bd98909183982d0cc53110a1da0.dir
      size: 143121002
      nfiles: 50
    - path: scripts/data_cleaning/make_rest_from_full.py
      hash: md5
      md5: 3bb53988de3fbe6a76eed0afa4b6aede
      size: 5388
    outs:
    - path: data/exploitation/modelos_input/rest_from_full
      hash: md5
      md5: 05e873d95fec452607af14e895877784.dir
      size: 353112531
      nfiles: 20
  evaluate_albert_rest:
    cmd: "python scripts/training/evaluate_albert.py --model_dir models/albert_sample_30pct
      --test_parquet data/exploitation/modelos_input/rest_from_full --output_dir reports/albert_sample_30pct/eval_rest
      --max_len 192\n"
    deps:
    - path: data/exploitation/modelos_input/rest_from_full
      hash: md5
      md5: 3d191c7bbccd2f2fbb5de1335383c429.dir
      size: 352996248
      nfiles: 20
    - path: models/albert_sample_30pct
      hash: md5
      md5: e45ca43f22c5129254eef74a3224e7e9.dir
      size: 49784962
      nfiles: 8
    - path: scripts/training/evaluate_albert.py
      hash: md5
      md5: 65666831a43b30e2c23a14ae56ac6214
      size: 10535
    outs:
    - path: reports/albert_sample_30pct/eval_rest
      hash: md5
      md5: 6ddfbe74ecac33d052ba902bd25f3846.dir
      size: 41250955
      nfiles: 6
