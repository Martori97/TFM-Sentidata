schema: '2.0'
stages:
  ingest_kaggle:
    cmd: "python scripts/data_ingestion/descarga_kaggle_reviews.py --out data/landing/sephora/raw\n"
    deps:
    - path: scripts/data_ingestion/descarga_kaggle_reviews.py
      hash: md5
      md5: e27b06cc672ef4f0b2347bf61ccb6322
      size: 762
    outs:
    - path: data/landing/sephora/raw
      hash: md5
      md5: 8b7019941c39ea0d57fae739d69994b5.dir
      size: 528949733
      nfiles: 6
  conversion_a_delta:
    cmd: "python scripts/data_cleaning/conversion_a_delta.py --input data/landing/sephora/raw
      --output data/landing/sephora/delta\n"
    deps:
    - path: data/landing/sephora/raw
      hash: md5
      md5: 8b7019941c39ea0d57fae739d69994b5.dir
      size: 528949733
      nfiles: 6
    - path: scripts/data_cleaning/conversion_a_delta.py
      hash: md5
      md5: f2e92a0eb8508d5d7f9f8543545af804
      size: 1737
    outs:
    - path: data/landing/sephora/delta
      hash: md5
      md5: 0d97cdd54e1d17a771fd7e1020f84f1f.dir
      size: 230118963
      nfiles: 172
  trusted_clean_driver:
    cmd: python scripts/data_cleaning/trusted_clean_driver.py --input 
      data/landing/sephora/delta --output data/trusted/sephora_clean
    deps:
    - path: data/landing/sephora/delta
      hash: md5
      md5: 0d97cdd54e1d17a771fd7e1020f84f1f.dir
      size: 230118963
      nfiles: 172
    - path: scripts/data_cleaning/trusted_clean_driver.py
      hash: md5
      md5: 12fb524919587f142c3e2d8a0b638787
      size: 805
    - path: scripts/data_cleaning/trusted_clean_single.py
      hash: md5
      md5: e9f9c94752272c42f4c257b369e68e8b
      size: 4336
    outs:
    - path: data/trusted/sephora_clean
      hash: md5
      md5: 53a01804458cea69bf59b941bcf22ced.dir
      size: 500916699
      nfiles: 252
  merge_trusted_reviews:
    cmd: python scripts/data_cleaning/merge_trusted_reviews.py --input-dir 
      data/trusted/sephora_clean --output data/trusted/reviews_full
    deps:
    - path: data/trusted/sephora_clean
      hash: md5
      md5: 53a01804458cea69bf59b941bcf22ced.dir
      size: 500916699
      nfiles: 252
    - path: scripts/data_cleaning/merge_trusted_reviews.py
      hash: md5
      md5: 328357b16b26547e2b06709acb583b63
      size: 5557
    outs:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14aa2cd5dcb06e55d1caedefa145be1e.dir
      size: 495378510
      nfiles: 18
  eda_full:
    cmd: "python scripts/EDA/eda_reviews.py --input data/trusted/reviews_full --outdir
      reports/eda/full --tokenizer albert-base-v2\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14aa2cd5dcb06e55d1caedefa145be1e.dir
      size: 495378510
      nfiles: 18
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/full
      hash: md5
      md5: 468d72acb76f922c40ea44be303550ea.dir
      size: 91181
      nfiles: 10
  sample_reviews:
    cmd: "python scripts/data_cleaning/sample_reviews.py --input data/trusted/reviews_full
      --output data/trusted/reviews_sample_30pct --frac 0.30 --by labels --seed 42\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 08549c8975b204736b6d85c1bb6a55a8.dir
      size: 493840996
      nfiles: 18
    - path: scripts/data_cleaning/sample_reviews.py
      hash: md5
      md5: b53be00c693d1b0eca07a1c53acbfe64
      size: 3658
    outs:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 2f4abe9eececec8710ea87937d163ea7.dir
      size: 148792281
      nfiles: 18
  eda_sample:
    cmd: python scripts/EDA/eda_reviews.py --input 
      data/trusted/reviews_sample_30pct --outdir reports/eda/sample_30pct 
      --tokenizer albert-base-v2
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 2f4abe9eececec8710ea87937d163ea7.dir
      size: 148792281
      nfiles: 18
    - path: params.yaml
      hash: md5
      md5: 1cc224cc01c4ed14dd211f948a3e9977
      size: 1052
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/sample_30pct
      hash: md5
      md5: f00407d91fdf27502b34286c503e82a3.dir
      size: 88768
      nfiles: 10
  eda_compare_full_vs_sample_30pct:
    cmd: python scripts/EDA/eda_compare.py --full reports/eda/full --sample 
      reports/eda/sample_30pct --outdir reports/eda/compare_full_vs_sample_30pct
    deps:
    - path: reports/eda/full
      hash: md5
      md5: 7bf3ddaa898dd7f5fd79c27084c2c550.dir
      size: 91160
      nfiles: 10
    - path: reports/eda/sample_30pct
      hash: md5
      md5: f00407d91fdf27502b34286c503e82a3.dir
      size: 88768
      nfiles: 10
    - path: scripts/EDA/eda_compare.py
      hash: md5
      md5: ccbfd0ac430439ce9b8480693f4f6702
      size: 6597
    outs:
    - path: reports/eda/compare_full_vs_sample_30pct
      hash: md5
      md5: ac22c9f240eab39a98b6d5ffa5db78a9.dir
      size: 6506
      nfiles: 7
  split_train_val_test:
    cmd: "python scripts/training/prepare_test_parquet.py --input  data/trusted/reviews_sample_30pct
      --outdir data/exploitation/modelos_input/sample_tvt --seed 42\n"
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: a0a857f2826c2aeac8bbf63cad72a202.dir
      size: 152150914
      nfiles: 130
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    - path: scripts/training/prepare_test_parquet.py
      hash: md5
      md5: 347ee9d1a01887aea96a63ae36cad088
      size: 4478
    outs:
    - path: data/exploitation/modelos_input/sample_tvt
      hash: md5
      md5: 8f5f7adb32b0ccf0c4d02b2a62d0a383.dir
      size: 141794268
      nfiles: 3
  train_albert_sample:
    cmd: "MLFLOW_RUN_NAME=albert_sample_30pct python scripts/training/train_albert_from_parquets.py
      --train data/exploitation/modelos_input/sample_tvt/train --val   data/exploitation/modelos_input/sample_tvt/val
      --model-out models/albert_sample_30pct --params params.yaml\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/train
      hash: md5
      md5: 758634d74a0efa6abbb5308ffc100b45.dir
      size: 106108929
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/val
      hash: md5
      md5: da67c9623ee5953c4e98f23a5ab95392.dir
      size: 14280029
      nfiles: 1
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    - path: scripts/training/train_albert_from_parquets.py
      hash: md5
      md5: abf0b5fb9563be466a538cf21764d5ad
      size: 31872
    outs:
    - path: models/albert_sample_30pct
      hash: md5
      md5: 414fcb18e0f5dd139aa3663e15a99aa6.dir
      size: 49789593
      nfiles: 8
  evaluate_albert_sample:
    cmd: "PYTHONNOUSERSITE=1 TRANSFORMERS_NO_TF=1 TRANSFORMERS_NO_JAX=1 USE_TF=0 USE_JAX=0
      /home/pedro/MASTER_BIGDATA/venv/bin/python scripts/training/evaluate_albert.py
      --model_dir models/albert_sample_30pct --test_parquet data/exploitation/modelos_input/sample_tvt/test
      --output_dir reports/albert_sample_30pct/eval\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/test
      hash: md5
      md5: c64fa2cc0635bba7ab950ed715d8b0dd.dir
      size: 21405310
      nfiles: 1
    - path: models/albert_sample_30pct
      hash: md5
      md5: 414fcb18e0f5dd139aa3663e15a99aa6.dir
      size: 49789593
      nfiles: 8
    - path: scripts/training/evaluate_albert.py
      hash: md5
      md5: 65666831a43b30e2c23a14ae56ac6214
      size: 10535
    outs:
    - path: reports/albert_sample_30pct/eval
      hash: md5
      md5: 35d2ff853a6b91605b006a47e1c67390.dir
      size: 2839266
      nfiles: 6
  train_albert:
    cmd: "python scripts/training/train_albert_from_parquets.py --train data/trusted/splits/train
      --val   data/trusted/splits/val --model-out models/albert_sample_30pct --params
      params.yaml\n"
    deps:
    - path: data/trusted/splits/train
      hash: md5
      md5: 65af6292cf6401a314390f0de62fc38a.dir
      size: 64893152
      nfiles: 18
    - path: data/trusted/splits/val
      hash: md5
      md5: fc3b1f9f978117ee50cd4c007fb2a2ae.dir
      size: 28380878
      nfiles: 18
    - path: params.yaml
      hash: md5
      md5: 5a9b64da1df3b206ebc3bf5bef6d42f3
      size: 3061
    - path: scripts/training/train_albert_from_parquets.py
      hash: md5
      md5: 26a546ff762a2c400ba78a867913b983
      size: 22305
    outs:
    - path: models/albert_sample_30pct
      hash: md5
      md5: c45f462a87128665e61a6c2fa9967281.dir
      size: 386202977
      nfiles: 35
  infer_albert_all:
    cmd: "python scripts/training/infer_albert_all.py --model_dir models/albert_sample_30pct
      --input_parquet data/trusted/reviews_full --output_parquet reports/albert_sample_30pct/infer/predictions.parquet
      --eval_output_dir reports/albert_sample_30pct/infer_eval_full --text_col review_text_clean
      --id_col review_id --label_col label --max_length 192 --batch_size 256 --labels
      negative neutral positive\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 660f5d166d2f7ad288ca7729c8deb3e9.dir
      size: 495606028
      nfiles: 24
    - path: models/albert_sample_30pct
      hash: md5
      md5: d71a6277af2ec5b4120fa66aea0113cf.dir
      size: 49784806
      nfiles: 8
    - path: scripts/training/infer_albert_all.py
      hash: md5
      md5: 0664a8fb2bf0e4cc6dccb16a5c9ba619
      size: 10348
    params:
      params.yaml:
        infer:
          model_dir: models/albert_sample_30pct
          input_parquet: data/trusted/reviews_full
          output_parquet: reports/albert_sample_30pct/infer/predictions.parquet
          eval_output_dir: reports/albert_sample_30pct/infer_eval_full
          text_col: review_text_clean
          id_col: review_id
          label_col: label
          batch_size: 1280
          max_length: 192
    outs:
    - path: reports/albert_sample_30pct/infer/predictions.parquet
      hash: md5
      md5: 17bea98847c6a5beeef26f487a17fa5e
      size: 42520506
  trusted_sample_30:
    cmd: "python scripts/data_cleaning/sample_reviews.py --input  data/trusted/reviews_full
      --output data/trusted/reviews_sample_30pct --frac 0.3 --by sentiment_category
      --format delta --seed 42 --coalesce 64 --balance true\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14aa2cd5dcb06e55d1caedefa145be1e.dir
      size: 495378510
      nfiles: 18
    - path: scripts/data_cleaning/sample_reviews.py
      hash: md5
      md5: 4e37eeb323e250f4613b96eb05dc7370
      size: 10609
    params:
      params.yaml:
        sampling:
          frac: 0.3
          by: sentiment_category
          seed: 42
          format: delta
          coalesce: 64
          balance: true
    outs:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: a0a857f2826c2aeac8bbf63cad72a202.dir
      size: 152150914
      nfiles: 130
  eda_sample_30:
    cmd: "python scripts/EDA/eda_reviews.py --input data/trusted/reviews_sample_30pct
      --outdir reports/eda/sample_30 --tokenizer albert-base-v2\n"
    deps:
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: a0a857f2826c2aeac8bbf63cad72a202.dir
      size: 152150914
      nfiles: 130
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    - path: scripts/EDA/eda_reviews.py
      hash: md5
      md5: 6235ecad747eb664623c25c539bb2a67
      size: 10430
    outs:
    - path: reports/eda/sample_30
      hash: md5
      md5: 7d1898633910ba4d4ee1fd3e15c7b247.dir
      size: 85492
      nfiles: 10
  eda_compare_full_vs_30:
    cmd: "python scripts/EDA/eda_compare.py --a data/trusted/reviews_full --b data/trusted/reviews_sample_30pct
      --outdir reports/eda/compare_full_vs_30 --by sentiment_category --input-format
      auto --tokenizer albert-base-v2 --sample-rows 120000 --max-len 128 --clip-tokens
      true --silence-tokenizer-warnings true\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14aa2cd5dcb06e55d1caedefa145be1e.dir
      size: 495378510
      nfiles: 18
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: a0a857f2826c2aeac8bbf63cad72a202.dir
      size: 152150914
      nfiles: 130
    - path: scripts/EDA/eda_compare.py
      hash: md5
      md5: 47f357297a778055cea6698a7b44810b
      size: 11381
    params:
      params.yaml:
        eda_compare_full_vs_30:
          a: data/trusted/reviews_full
          b: data/trusted/reviews_sample_30pct
          outdir: reports/eda/compare_full_vs_30
          by: sentiment_category
          input_format: auto
          tokenizer: albert-base-v2
          sample_rows: 120000
          max_len: 128
          clip_tokens: true
          silence_tokenizer_warnings: true
    outs:
    - path: reports/eda/compare_full_vs_30
      hash: md5
      md5: 81816daad345e98f3fdb6448ba8b8357.dir
      size: 57791
      nfiles: 24
  infer_albert_forward:
    cmd: "PYTHONNOUSERSITE=1 TRANSFORMERS_NO_TF=1 TRANSFORMERS_NO_JAX=1 USE_TF=0 USE_JAX=0
      /home/pedro/MASTER_BIGDATA/venv/bin/python scripts/training/infer_albert_all.py
      --model_dir models/albert_sample_30pct --input_parquet data/trusted/reviews_full
      --output_parquet reports/albert_sample_30pct/infer/predictions.parquet --eval_output_dir
      reports/albert_sample_30pct/infer_eval_full --text_col review_text_clean --id_col
      review_id --batch_size 128\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: aeee9d89c9d221c5a91da28ee292a39b.dir
      size: 494842050
      nfiles: 82
    - path: models/albert_sample_30pct
      hash: md5
      md5: d71a6277af2ec5b4120fa66aea0113cf.dir
      size: 49784806
      nfiles: 8
    - path: scripts/training/infer_albert_all.py
      hash: md5
      md5: 24f7a940fafa350c7ee192dba1f2969b
      size: 4038
    outs:
    - path: reports/albert_sample_30pct/infer/predictions.parquet
      hash: md5
      md5: a5fedaafa341c219fec1b6bb8c03bb76
      size: 43106181
  make_rest_from_full:
    cmd: "python scripts/data_cleaning/make_rest_from_full.py --full data/trusted/reviews_full
      --sample-root data/exploitation/modelos_input/sample_tvt --sample-delta data/trusted/reviews_sample_30pct
      --out data/exploitation/modelos_input/rest_from_full --format parquet --coalesce
      64\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/test
      hash: md5
      md5: bfa024e0523b5306f46976ba7d064f60.dir
      size: 21251257
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/train
      hash: md5
      md5: 9209563c84f500f95462c3c20a78aaf0.dir
      size: 106044050
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/val
      hash: md5
      md5: 3897382c33dacb582249c542f7c79759.dir
      size: 14238818
      nfiles: 1
    - path: data/trusted/reviews_full
      hash: md5
      md5: 4485207d96ba5a6d739a8b5570c6df6d.dir
      size: 495378510
      nfiles: 18
    - path: data/trusted/reviews_sample_30pct
      hash: md5
      md5: 3c913bd98909183982d0cc53110a1da0.dir
      size: 143121002
      nfiles: 50
    - path: scripts/data_cleaning/make_rest_from_full.py
      hash: md5
      md5: 3bb53988de3fbe6a76eed0afa4b6aede
      size: 5388
    outs:
    - path: data/exploitation/modelos_input/rest_from_full
      hash: md5
      md5: 05e873d95fec452607af14e895877784.dir
      size: 353112531
      nfiles: 20
  evaluate_albert_rest:
    cmd: "python scripts/training/evaluate_albert.py --model_dir models/albert_sample_30pct
      --test_parquet data/exploitation/modelos_input/rest_from_full --output_dir reports/albert_sample_30pct/eval_rest
      --max_len 192\n"
    deps:
    - path: data/exploitation/modelos_input/rest_from_full
      hash: md5
      md5: 3d191c7bbccd2f2fbb5de1335383c429.dir
      size: 352996248
      nfiles: 20
    - path: models/albert_sample_30pct
      hash: md5
      md5: e45ca43f22c5129254eef74a3224e7e9.dir
      size: 49784962
      nfiles: 8
    - path: scripts/training/evaluate_albert.py
      hash: md5
      md5: 65666831a43b30e2c23a14ae56ac6214
      size: 10535
    outs:
    - path: reports/albert_sample_30pct/eval_rest
      hash: md5
      md5: 6ddfbe74ecac33d052ba902bd25f3846.dir
      size: 41250955
      nfiles: 6
  infer_top50_upvoted_ulta:
    cmd: "python scripts/infer/infer_top_upvoted_ulta.py --input_delta \"data/trusted/ulta_clean/Ulta
      Skincare Reviews\" --model_dir models/albert_sample_30pct --top_n 50 --output_parquet
      reports/albert_sample_30pct/infer_top50_upvoted_ulta/predictions.parquet\n"
    deps:
    - path: data/trusted/ulta_clean/Ulta Skincare Reviews
      hash: md5
      md5: beebb92e4be0fdb3bc2b5731308aa47c.dir
      size: 3627645
      nfiles: 24
    - path: models/albert_sample_30pct
      hash: md5
      md5: 923ed8e16d5c6e248094aff1bf38c3cf.dir
      size: 49784962
      nfiles: 8
    - path: scripts/infer/infer_top_upvoted_ulta.py
      hash: md5
      md5: 5c9dc38cb146fbe6d20410672e70c6e3
      size: 10397
    outs:
    - path: reports/albert_sample_30pct/infer_top50_upvoted_ulta
      hash: md5
      md5: d75802f5892bc2910d1f23ecaa5ca57b.dir
      size: 53824
      nfiles: 12
  merge_reviews_product_info:
    cmd: "python scripts/data_cleaning/merge_reviews_product_info.py --reviews_path
      data/trusted/reviews_full --product_info_path data/trusted/sephora_clean/product_info
      --output_path data/trusted/reviews_product_info_clean_full --input_format auto
      --output_format delta --repartition 0 --coalesce 64 --product_prefix pinfo_
      --broadcast_product_info true\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14aa2cd5dcb06e55d1caedefa145be1e.dir
      size: 495378510
      nfiles: 18
    - path: data/trusted/sephora_clean/product_info
      hash: md5
      md5: 4df2032a9266db9d0fe8e1a2cbda5752.dir
      size: 2869951
      nfiles: 12
    - path: scripts/data_cleaning/merge_reviews_product_info.py
      hash: md5
      md5: 8146cb418204fc6ac7c89d9e5ef61ca9
      size: 7736
    params:
      params.yaml:
        merge_reviews_product_info.broadcast_product_info: 'true'
        merge_reviews_product_info.coalesce: 64
        merge_reviews_product_info.input_format: auto
        merge_reviews_product_info.output_format: delta
        merge_reviews_product_info.product_prefix: pinfo_
        merge_reviews_product_info.repartition: 0
        paths:
          reviews_full: data/trusted/reviews_full
          product_info: data/trusted/sephora_clean/product_info
          merged_out: data/trusted/reviews_product_info_clean_full
    outs:
    - path: data/trusted/reviews_product_info_clean_full
      hash: md5
      md5: 40249586ccdac4a280e3a52a0f80cb42.dir
      size: 796564328
      nfiles: 20
  gen_aspects_json:
    cmd: "python -c \"import os, json, yaml; d=yaml.safe_load(open('params.yaml'));
      os.makedirs('configs', exist_ok=True); json.dump(d['aspects_ontology_en'], open('configs/aspects_en.json','w'),
      ensure_ascii=False, indent=2)\"\n"
    deps:
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    params:
      params.yaml:
        aspects_ontology_en:
          fragrance:
          - fragrance
          - scent
          - smell
          - aroma
          - perfume
          - notes
          - odor
          - fragrant
          longevity:
          - longevity
          - long-lasting
          - lasting
          - wear time
          - duration
          - staying power
          sillage:
          - sillage
          - projection
          - trail
          - leaves a trail
          price:
          - price
          - price point
          - cost
          - value
          - worth
          - expensive
          - cheap
          - overpriced
          packaging:
          - packaging
          - bottle
          - cap
          - pump
          - box
          - container
          - design
          texture:
          - texture
          - consistency
          - feel
          - thick
          - thin
          - creamy
          - watery
          - sticky
          - greasy
          - lightweight
          - silky
          hydration:
          - hydration
          - moisturizing
          - hydrating
          - moisture
          - drying
          - dehydrating
          application:
          - application
          - apply
          - applies
          - spreads
          - absorbs
          - glides
          - blendability
          - easy to use
          finish:
          - finish
          - matte
          - dewy
          - glowy
          - glossy
          - sheen
          - shine
          irritation:
          - irritation
          - irritates
          - sting
          - burning
          - redness
          - itch
          - breakout
          - allergic
          - sensitivity
          ingredients:
          - ingredients
          - alcohol
          - parabens
          - sulfates
          - silicones
          - fragrance-free
          - clean
          - formula
          effectiveness:
          - effectiveness
          - works
          - results
          - performance
          - improvement
          - does nothing
    outs:
    - path: configs/aspects_en.json
      hash: md5
      md5: 1f1cbebab683cf097855ecfa9cfdecd8
      size: 1617
  build_ate_trusted:
    cmd: "python scripts/absa/build_ate_trusted_from_ontology.py --input_path data/trusted/reviews_product_info_clean_full
      --input_format delta --text_col review_text_clean --id_col review_id --ontology_json
      configs/aspects_en.json --output_dir data/trusted/ate --train_filename train.jsonl
      --valid_filename valid.jsonl --sample_fraction 0.2 --max_reviews 300000 --train_valid_split
      0.9 --keep_neg_ratio 0.2 --seed 13\n"
    deps:
    - path: configs/aspects_en.json
      hash: md5
      md5: 1f1cbebab683cf097855ecfa9cfdecd8
      size: 1617
    - path: data/trusted/reviews_product_info_clean_full
      hash: md5
      md5: 40249586ccdac4a280e3a52a0f80cb42.dir
      size: 796564328
      nfiles: 20
    - path: scripts/absa/build_ate_trusted_from_ontology.py
      hash: md5
      md5: 0f4076985d3d58641f55425086c1cbfd
      size: 7793
    params:
      params.yaml:
        ate_train.train_path: data/trusted/ate/train.jsonl
        ate_train.valid_path: data/trusted/ate/valid.jsonl
        ate_trusted:
          input_path: data/trusted/reviews_product_info_clean_full
          input_format: delta
          text_col: review_text_clean
          id_col: review_id
          ontology_json: configs/aspects_en.json
          output_dir: data/trusted/ate
          train_filename: train.jsonl
          valid_filename: valid.jsonl
          sample_fraction: 0.2
          max_reviews: 300000
          train_valid_split: 0.9
          keep_neg_ratio: 0.2
          seed: 13
    outs:
    - path: data/trusted/ate/train.jsonl
      hash: md5
      md5: 8308da9617a3434195f86d3de95c7e5e
      size: 132415402
    - path: data/trusted/ate/valid.jsonl
      hash: md5
      md5: 4c9b77e153ed9651dfd6d569bf20ae71
      size: 14774498
  train_ate_bio:
    cmd: "python scripts/absa/train_ate_bio.py --train_path data/trusted/ate/train.jsonl
      --valid_path data/trusted/ate/valid.jsonl --model_name roberta-base --output_dir
      models/ate_roberta_base --epochs 4 --lr 2e-05 --batch_size 32 --grad_accum 2
      --max_length 192 --fp16 false --bf16 true --grad_checkpoint false --dataloader_workers
      8\n"
    deps:
    - path: data/trusted/ate/train.jsonl
      hash: md5
      md5: 8308da9617a3434195f86d3de95c7e5e
      size: 132415402
    - path: data/trusted/ate/valid.jsonl
      hash: md5
      md5: 4c9b77e153ed9651dfd6d569bf20ae71
      size: 14774498
    - path: scripts/absa/train_ate_bio.py
      hash: md5
      md5: 2d388cccc6f6208197038b4dec501bbb
      size: 9197
    params:
      params.yaml:
        ate_train:
          model_name: roberta-base
          output_dir: models/ate_roberta_base
          epochs: 4
          lr: 2e-05
          batch_size: 32
          grad_accum: 2
          max_length: 192
          fp16: false
          bf16: true
          grad_checkpoint: false
          dataloader_workers: 8
          train_path: data/trusted/ate/train.jsonl
          valid_path: data/trusted/ate/valid.jsonl
    outs:
    - path: models/ate_roberta_base
      hash: md5
      md5: d64bae8e030c409fed1f1a4dc63174b1.dir
      size: 1994821241
      nfiles: 20
  infer_ate_spans:
    cmd: "python scripts/absa/infer_ate_spans.py --model_dir models/ate_roberta_base
      --input_path data/trusted/reviews_product_info_clean_full --input_format delta
      --text_col review_text_clean --id_col review_id --output_parquet reports/absa/ate_spans.parquet
      --max_length 192 --batch_size 128 --flush_rows 25000\n"
    deps:
    - path: data/trusted/reviews_product_info_clean_full
      hash: md5
      md5: 40249586ccdac4a280e3a52a0f80cb42.dir
      size: 796564328
      nfiles: 20
    - path: models/ate_roberta_base
      hash: md5
      md5: d64bae8e030c409fed1f1a4dc63174b1.dir
      size: 1994821241
      nfiles: 20
    - path: scripts/absa/infer_ate_spans.py
      hash: md5
      md5: b57c3d9890578e13d1eac09d51759be9
      size: 12960
    params:
      params.yaml:
        ate_infer:
          model_dir: models/ate_roberta_base
          input_path: data/trusted/reviews_product_info_clean_full
          input_format: delta
          text_col: review_text_clean
          id_col: review_id
          output_parquet: reports/absa/ate_spans.parquet
          max_length: 192
          batch_size: 128
          flush_rows: 25000
    outs:
    - path: reports/absa/ate_spans.parquet
      hash: md5
      md5: 86b2781e945fd49d098974e099297df2
      size: 40065363
  map_ate_spans:
    cmd: "python scripts/absa/map_spans_to_ontology.py --spans_parquet reports/absa/ate_spans.parquet
      --ontology_json configs/aspects_en.json --output_parquet reports/absa/ate_spans_mapped.parquet
      --threshold 0.45\n"
    deps:
    - path: configs/aspects_en.json
      hash: md5
      md5: 1f1cbebab683cf097855ecfa9cfdecd8
      size: 1617
    - path: reports/absa/ate_spans.parquet
      hash: md5
      md5: 86b2781e945fd49d098974e099297df2
      size: 40065363
    - path: scripts/absa/map_spans_to_ontology.py
      hash: md5
      md5: 2a66e66e776129c17888700ec3fec240
      size: 3146
    params:
      params.yaml:
        ate_map:
          spans_parquet: reports/absa/ate_spans.parquet
          ontology_json: configs/aspects_en.json
          output_parquet: reports/absa/ate_spans_mapped.parquet
          threshold: 0.45
    outs:
    - path: reports/absa/ate_spans_mapped.parquet
      hash: md5
      md5: 8ed9df311e42967ad65b72aa98f581b2
      size: 35677072
  absa_build_all:
    cmd: "python scripts/absa/build_absa_dataset.py --spans_parquet reports/absa/ate_spans.parquet
      --map_parquet   reports/absa/ate_spans_mapped.parquet --sentiment_parquet reports/albert_sample_30pct/infer_full_pandas/predictions.parquet
      --id_col review_id --span_text_col aspect_span --category_col aspect_norm --sentiment_col
      pred_3 --output_dir reports/absa/final_all\n"
    deps:
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    - path: reports/absa/ate_spans.parquet
      hash: md5
      md5: 86b2781e945fd49d098974e099297df2
      size: 40065363
    - path: reports/absa/ate_spans_mapped.parquet
      hash: md5
      md5: 8ed9df311e42967ad65b72aa98f581b2
      size: 35677072
    - path: reports/albert_sample_30pct/infer_full_pandas/predictions.parquet
      hash: md5
      md5: 03a6c78ea31841b195d22380235d0e10
      size: 57387489
    - path: scripts/absa/build_absa_dataset.py
      hash: md5
      md5: 37777cd65e975fafb0adb50ead1c0e9e
      size: 17156
    outs:
    - path: reports/absa/final_all
      hash: md5
      md5: 497a6b27f38fdcd95ffaaef9aab3e204.dir
      size: 33228497
      nfiles: 77
  absa_eval_thr90:
    cmd: "python scripts/absa/metrics_from_predictions.py --predictions_parquet reports/albert_sample_30pct/eval/predictions.parquet
      --out_dir reports/absa/phase2_eval_thr90 --neutral_threshold 0.90\n"
    deps:
    - path: reports/albert_sample_30pct/eval/predictions.parquet
      hash: md5
      md5: 87938fb8ebe761a3cf982fb371a7cd71
      size: 2781658
    - path: scripts/absa/metrics_from_predictions.py
      hash: md5
      md5: a8e85593c5282a85394a428859a2f507
      size: 7372
    outs:
    - path: reports/absa/phase2_eval_thr90
      hash: md5
      md5: 19d30eb8ab1be7b372dcc74e98378539.dir
      size: 2899394
      nfiles: 12
  absa_eval_thr80:
    cmd: "python scripts/absa/metrics_from_predictions.py --predictions_parquet reports/albert_sample_30pct/eval/predictions.parquet
      --out_dir reports/absa/phase2_eval_thr80 --neutral_threshold 0.80 --save_changed\n"
    deps:
    - path: reports/albert_sample_30pct/eval/predictions.parquet
      hash: md5
      md5: 87938fb8ebe761a3cf982fb371a7cd71
      size: 2781658
    - path: scripts/absa/metrics_from_predictions.py
      hash: md5
      md5: a8e85593c5282a85394a428859a2f507
      size: 7372
    outs:
    - path: reports/absa/phase2_eval_thr80
      hash: md5
      md5: fea170677b3f1c816c30def156893995.dir
      size: 3171819
      nfiles: 13
  absa_eval_thr65:
    cmd: "python scripts/absa/metrics_from_predictions.py --predictions_parquet reports/albert_sample_30pct/eval/predictions.parquet
      --out_dir reports/absa/phase2_eval_thr65 --neutral_threshold 0.65 --save_changed\n"
    deps:
    - path: reports/albert_sample_30pct/eval/predictions.parquet
      hash: md5
      md5: 87938fb8ebe761a3cf982fb371a7cd71
      size: 2781658
    - path: scripts/absa/metrics_from_predictions.py
      hash: md5
      md5: a8e85593c5282a85394a428859a2f507
      size: 7372
    outs:
    - path: reports/absa/phase2_eval_thr65
      hash: md5
      md5: 9da07f23a01aca0d592402e7daab6614.dir
      size: 3021481
      nfiles: 13
  prepare_ABSA_test_full_dataset:
    cmd: "python scripts/training/prepare_test_parquet.py --input data/trusted/reviews_full
      --outdir data/exploitation/modelos_input/ABSA_test_full_dataset --seed 42\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 4485207d96ba5a6d739a8b5570c6df6d.dir
      size: 495378510
      nfiles: 18
    - path: scripts/training/prepare_test_parquet.py
      hash: md5
      md5: 347ee9d1a01887aea96a63ae36cad088
      size: 4478
    outs:
    - path: data/exploitation/modelos_input/ABSA_test_full_dataset
      hash: md5
      md5: 3077d178f8c76c68c7613731377568c2.dir
      size: 495740344
      nfiles: 3
  convert_delta_to_parquet_snapshot:
    cmd: python scripts/infer/convert_delta_to_parquet_snapshot.py --input_path 
      data/trusted/reviews_full --output_path 
      data/trusted/reviews_full_snapshot.parquet
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14aa2cd5dcb06e55d1caedefa145be1e.dir
      size: 495378510
      nfiles: 18
    - path: scripts/infer/convert_delta_to_parquet_snapshot.py
      hash: md5
      md5: 72fcd16d30038f1c1451001882fdb246
      size: 1059
    outs:
    - path: data/trusted/reviews_full_snapshot.parquet
      hash: md5
      md5: 44dd11b02dc93efec0fba31d50d3744a.dir
      size: 495361508
      nfiles: 20
  infer_sentiment_full_pandas:
    cmd: python scripts/infer/infer_sentiment_full_pandas.py --model_dir 
      models/albert_sample_30pct --input_parquet 
      data/trusted/reviews_full_snapshot.parquet --output_parquet 
      reports/albert_sample_30pct/infer_full_pandas/predictions.parquet 
      --params_file params.yaml
    deps:
    - path: data/trusted/reviews_full_snapshot.parquet
      hash: md5
      md5: 44dd11b02dc93efec0fba31d50d3744a.dir
      size: 495361508
      nfiles: 20
    - path: models/albert_sample_30pct
      hash: md5
      md5: 414fcb18e0f5dd139aa3663e15a99aa6.dir
      size: 49789593
      nfiles: 8
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    - path: scripts/infer/infer_sentiment_full_pandas.py
      hash: md5
      md5: 4d6ce84c3b555a0d7050301b07641dd8
      size: 4054
    params:
      params.yaml:
        infer_sentiment_full_pandas.batch_size: 64
        infer_sentiment_full_pandas.id_col: review_id
        infer_sentiment_full_pandas.max_length: 192
        infer_sentiment_full_pandas.text_col: review_text_clean
    outs:
    - path: reports/albert_sample_30pct/infer_full_pandas/predictions.parquet
      hash: md5
      md5: 03a6c78ea31841b195d22380235d0e10
      size: 57387489
  train_rf_sample:
    cmd: "MLFLOW_RUN_NAME=rf_sample_30pct python scripts/training/train_random_forest.py
      --train data/exploitation/modelos_input/sample_tvt/train --val   data/exploitation/modelos_input/sample_tvt/val
      --model-out models/sentiment_rf_sample --params params.yaml\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/train
      hash: md5
      md5: 758634d74a0efa6abbb5308ffc100b45.dir
      size: 106108929
      nfiles: 1
    - path: data/exploitation/modelos_input/sample_tvt/val
      hash: md5
      md5: da67c9623ee5953c4e98f23a5ab95392.dir
      size: 14280029
      nfiles: 1
    - path: params.yaml
      hash: md5
      md5: fdf1c225423e3744f04cf8d3e1a8678f
      size: 5836
    - path: scripts/training/train_random_forest.py
      hash: md5
      md5: 514f31ec650499ee2998b0ec845527df
      size: 9625
    outs:
    - path: models/sentiment_rf_sample
      hash: md5
      md5: 3a203eb3349d6e8ffed950f232b2d7a2.dir
      size: 1482049207
      nfiles: 3
    - path: reports/sentiment_rf
      hash: md5
      md5: 81b7544552bc75d79fe1be3831487662.dir
      size: 17375
      nfiles: 1
  evaluate_rf_sample:
    cmd: "python scripts/training/infer_random_forest.py --model-dir models/sentiment_rf_sample
      --input data/exploitation/modelos_input/sample_tvt/test --output-dir reports/sentiment_rf_sample/eval
      --text-col review_text --id-col review_id --use-extra 1 && python scripts/evaluation/metrics_overall.py
      --preds reports/sentiment_rf_sample/eval/test_predictions.parquet --out_dir
      reports/sentiment_rf_sample/eval\n"
    deps:
    - path: data/exploitation/modelos_input/sample_tvt/test
      hash: md5
      md5: c64fa2cc0635bba7ab950ed715d8b0dd.dir
      size: 21405310
      nfiles: 1
    - path: models/sentiment_rf_sample
      hash: md5
      md5: 3a203eb3349d6e8ffed950f232b2d7a2.dir
      size: 1482049207
      nfiles: 3
    - path: scripts/evaluation/metrics_overall.py
      hash: md5
      md5: 5f870271995dc8e4e110e56c3fe57a02
      size: 2244
      isexec: true
    - path: scripts/training/infer_random_forest.py
      hash: md5
      md5: aaf54ed2f382cf9247b1742ebb4c4ad1
      size: 8716
    outs:
    - path: reports/sentiment_rf_sample/eval
      hash: md5
      md5: e84eea098caa7ce4b4b06690fb146e85.dir
      size: 2023370
      nfiles: 4
  infer_rf_all:
    cmd: "python scripts/training/infer_random_forest.py --model-dir models/sentiment_rf_sample
      --input data/trusted/reviews_full --output-dir reports/sentiment_rf_sample/infer
      --text-col review_text --id-col review_id --use-extra 1 && python scripts/evaluation/metrics_overall.py
      --preds reports/sentiment_rf_sample/infer/test_predictions.parquet --out_dir
      reports/sentiment_rf_sample/infer_eval_full\n"
    deps:
    - path: data/trusted/reviews_full
      hash: md5
      md5: 14aa2cd5dcb06e55d1caedefa145be1e.dir
      size: 495378510
      nfiles: 18
    - path: models/sentiment_rf_sample
      hash: md5
      md5: 3a203eb3349d6e8ffed950f232b2d7a2.dir
      size: 1482049207
      nfiles: 3
    - path: scripts/evaluation/metrics_overall.py
      hash: md5
      md5: 5f870271995dc8e4e110e56c3fe57a02
      size: 2244
      isexec: true
    - path: scripts/training/infer_random_forest.py
      hash: md5
      md5: aaf54ed2f382cf9247b1742ebb4c4ad1
      size: 8716
    outs:
    - path: reports/sentiment_rf_sample/infer
      hash: md5
      md5: fa38debcbf0f4d8fa5bb42d9ddd69f55.dir
      size: 42770315
      nfiles: 1
    - path: reports/sentiment_rf_sample/infer_eval_full
      hash: md5
      md5: 559085834cd433896cc671f4d2e970c1.dir
      size: 58966
      nfiles: 3
  infer_ulta_top50_albert:
    cmd: "python scripts/infer/infer_top_upvoted_ulta.py --backend albert --input_delta
      'data/trusted/ulta_clean/Ulta Skincare Reviews' --model_dir models/albert_sample_30pct
      --top_n 50 --max_len 192 --batch_size 64 --output_parquet reports/albert_sample_30pct/ulta_top50/predictions.parquet
      --coalesce 1 --demote_neutral 1 --min_neutral_prob 0.90\n"
    deps:
    - path: data/trusted/ulta_clean/Ulta Skincare Reviews
      hash: md5
      md5: beebb92e4be0fdb3bc2b5731308aa47c.dir
      size: 3627645
      nfiles: 24
    - path: models/albert_sample_30pct
      hash: md5
      md5: 414fcb18e0f5dd139aa3663e15a99aa6.dir
      size: 49789593
      nfiles: 8
    - path: scripts/infer/infer_top_upvoted_ulta.py
      hash: md5
      md5: 38047141fadb6c2443cf255888a88e75
      size: 13255
    outs:
    - path: reports/albert_sample_30pct/ulta_top50
      hash: md5
      md5: 62d93a7c7b34a9d6ed8f6b8393439379.dir
      size: 51986
      nfiles: 12
  infer_ulta_top50_rf:
    cmd: "python scripts/infer/infer_top_upvoted_ulta.py --backend rf --input_delta
      'data/trusted/ulta_clean/Ulta Skincare Reviews' --model_dir models/sentiment_rf_sample
      --top_n 50 --output_parquet reports/sentiment_rf_sample/ulta_top50/predictions.parquet
      --coalesce 1 --demote_neutral 1 --min_neutral_prob 0.90 --use_title 1 --use_extra
      1\n"
    deps:
    - path: data/trusted/ulta_clean/Ulta Skincare Reviews
      hash: md5
      md5: beebb92e4be0fdb3bc2b5731308aa47c.dir
      size: 3627645
      nfiles: 24
    - path: models/sentiment_rf_sample
      hash: md5
      md5: 3a203eb3349d6e8ffed950f232b2d7a2.dir
      size: 1482049207
      nfiles: 3
    - path: scripts/infer/infer_top_upvoted_ulta.py
      hash: md5
      md5: 38047141fadb6c2443cf255888a88e75
      size: 13255
    outs:
    - path: reports/sentiment_rf_sample/ulta_top50
      hash: md5
      md5: 70a129195afd12f3303c84021862abfb.dir
      size: 49543
      nfiles: 12
